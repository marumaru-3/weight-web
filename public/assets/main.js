const B=e=>{const t=e.replace(/^\/+/,"");return`${BASE_PATH}${t}`},G=e=>{const t=document.createElement("div");t.textContent=e,t.classList.add("copy-dialog"),document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>t.classList.remove("show"),1500),setTimeout(()=>t.remove(),2e3)};document.addEventListener("click",e=>{if(e.target.classList.contains("copy-link")){const t=e.target.closest(".copy-contents").querySelector(".copy__value");t&&(navigator.clipboard.writeText(t.textContent),document.querySelector(".copy-dialog")||G("IDをコピーしました。"))}});const q=async(e,t="GET",a=null,n={})=>{const s=await fetch(e,{method:t,body:a,...n});try{if(!s.ok)throw s.status===401&&(alert("ログインが必要です。"),window.location.href=B("/welcome")),new Error(`APIエラー: ${s.status}`);const l=s.headers.get("Content-Type");return l&&l.includes("application/json")?await s.json():await s.text()}catch(l){return console.log("エラー:",l),console.log("デバッグ:",await s.text()),{success:!1,message:"通信エラーが発生しました。"}}},N=async e=>q(B(`/index.php?modal=${e}`)),U=async()=>q(B("/php/api/chart_data.php")),z=e=>{const t=e.target.closest("[data-date]");return t?t.dataset.date:null},J=async e=>{const t=z(e);return t?q(B(`/php/api/record_data.php?date=${t}`)):(console.log("日付を取得できませんでした。"),{success:!1,message:"日付を取得できませんでした。"})},Q=async()=>q(B("/php/api/user_data.php")),R=async()=>{const e=document.querySelectorAll(".pwd-btn");e.length&&e.forEach(t=>{t.addEventListener("click",()=>{const a=t.previousElementSibling,n=a.tagName.toLowerCase(),s=t.firstElementChild,l=t.dataset.hidden==="true";n==="input"&&(a.type=l?"text":"password"),l?s.innerHTML="visibility_off":s.innerHTML="visibility",t.dataset.hidden=!l})})},P=document.querySelector("body"),V=document.getElementById("layout");let j=!1;const F=async(e,t=null)=>{if(j)return;j=!0;let a=null;e==="recordAdmin"&&t&&(a=await J(t)),e==="adminUser"&&(a=await Q());const n=await N(e);V.insertAdjacentHTML("afterend",n),P.style.overflow="hidden",K(e,a),R(),document.querySelectorAll(".close-modal").forEach(l=>{l&&l.addEventListener("click",W)}),j=!1},W=()=>{const e=document.getElementById("modal");e&&(e.remove(),P.style.overflow="",R())},Y=document.querySelectorAll("[data-modal]");Y.forEach(e=>{e.addEventListener("click",t=>{const a=e.getAttribute("data-modal");F(a,t)})});document.addEventListener("click",e=>{const t=document.querySelector("#modal.record, #modal.recordAdmin");t&&e.target===t&&W()});sessionStorage.getItem("accountCreated")==="true"&&(F("accountCreated"),sessionStorage.removeItem("accountCreated"));showIdModal&&F("idCheck");const K=(e,t)=>{const n={record:"./init/record.js",recordAdmin:"./init/record-admin.js",recordReset:"./init/record-reset.js",adminAccount:"./init/user-info.js",adminUser:"./init/user-info.js",login:"./init/login.js",register:"./init/register.js",accountCreated:"./init/account-created.js",accountDelete:"./init/account-delete.js"}[e];n&&import(n).then(s=>s.init(t))},X=()=>{const e=document.getElementById("header");if(!e)return;const t=e.offsetHeight;let a=0;window.addEventListener("load",()=>{window.addEventListener("scroll",()=>{const p=window.scrollY||document.documentElement.scrollTop;p>a&&p>t?e.style.top=`-${t}px`:e.style.top="0",a=p})});const n=document.getElementById("menu-toggle"),s=document.querySelector(".layout__sidebar");n.addEventListener("click",()=>{s.classList.contains("open")?(s.classList.remove("open"),s.classList.add("close")):(s.classList.remove("close"),s.classList.add("open"))});const l=window.matchMedia("(max-width: 1299px)"),y=p=>{p.matches?(s.classList.remove("open"),s.classList.add("close")):(s.classList.remove("close"),s.classList.add("open"))};y(l),l.addEventListener("change",y),document.addEventListener("click",p=>{p.target.closest(".layout__sidebar")||l.matches&&(s.classList.remove("open"),s.classList.add("close"))})},Z=()=>{const e=document.querySelectorAll(".accordion-btn");e&&e.forEach(t=>{t.addEventListener("click",()=>{const a=t.closest(".accordion"),n=a.querySelector(".accordion-content");a.getAttribute("data-state")==="open"?(n.style.maxHeight=n.scrollHeight+"px",requestAnimationFrame(()=>{n.style.maxHeight="0"}),a.setAttribute("data-state","close")):(n.style.maxHeight=n.scrollHeight+"px",a.setAttribute("data-state","open"))})})},ee=()=>{const e=document.getElementById("header__info"),t=document.getElementById("header__profile"),a=document.getElementById("user-popup");e&&(t.addEventListener("click",n=>{e.classList.contains("click")?e.classList.remove("click"):e.classList.add("click"),n.stopPropagation()}),document.addEventListener("click",n=>{!a.contains(n.target)&&n.target!==e&&e.classList.remove("click")}))},te=()=>{const e=document.querySelector(".weight-days__blocks"),t=document.querySelectorAll(".weight-days__block");if(!e)return;const a=g=>[...t].sort((f,w)=>{const o=f.querySelector(".weight-days__date").textContent,C=w.querySelector(".weight-days__date").textContent;return g?o<C?-1:1:o>C?-1:1});let n=!1;e.innerHTML="",a(n).forEach(g=>e.appendChild(g));const s=document.querySelector(".weight-days .btn--more");let l=6;const y=g=>{g.forEach((f,w)=>{w<l?f.classList.add("show"):f.classList.contains("show")&&f.classList.remove("show")}),l>=g.length&&s.classList.add("hide")};y(a(n)),s.addEventListener("click",()=>{l+=6,y(a(n))}),document.querySelectorAll(".weight-days__switch button").forEach(g=>{g.addEventListener("click",()=>{var f;(f=document.querySelector(".weight-days__switch .btn--select"))==null||f.classList.remove("btn--select"),g.classList.add("btn--select"),n?n=!1:n=!0,e.innerHTML="",a(n).forEach(w=>e.appendChild(w)),y(a(n))})})},ne=async()=>{const e=document.getElementById("graph");if(!e)return;const t=await U(),a=t.chart_arr,n=t.ideal_weight;Chart.register(window["chartjs-plugin-annotation"]);const s=(c,d=!1)=>{const r=new Date;r.setHours(0,0,0,0);let E=new Date(r.setDate(r.getDate()+1)),_=new Date(r);const L={"7d":[7,14],"1m":[1,2],"3m":[3,6],"6m":[6,12],"1y":[12,24]};c==="7d"?(E.setDate(r.getDate()-(d?L[c][1]:L[c][0])),d&&_.setDate(r.getDate()-L[c][0])):(E.setMonth(r.getMonth()-(d?L[c][1]:L[c][0])),d&&_.setMonth(r.getMonth()-L[c][0]));let m=[],h=new Date(E);for(;h<_;)m.push(new Date(h.getTime()-h.getTimezoneOffset()*6e4).toISOString().split("T")[0]),h.setDate(h.getDate()+1);return m},l=(c,d=!1)=>{const r=s(c,d),E=Object.fromEntries(a.map(u=>[u.date,u.weight])),_=Object.fromEntries(a.map(u=>[u.date,u.bmi])),L=Object.fromEntries(a.map(u=>[u.date,u.bfp])),m=r.map(u=>E[u]??null),h=r.map(u=>_[u]??null),D=r.map(u=>L[u]??null);return{labels:r,dataset:m,bmi:h,bfp:D}},y=window.matchMedia("(max-width: 599px)");let p;const g=c=>{const{labels:d,dataset:r}=l(c),E=d.map(m=>m.replaceAll("-","/")),_=e.getContext("2d");p&&p.destroy(),p=new Chart(_,{type:"line",data:{labels:E,datasets:[{label:"体重（kg）",data:r,backgroundColor:"#4a90e2",borderColor:"#4a90e2",borderWidth:2,pointRadius:4,pointBackgroundColor:"#fff",pointBorderColor:"#4a90e2",pointBorderWidth:3,hoverBorderWidth:4,pointHoverRadius:6,spanGaps:!0}]},options:{responsive:!0,maintainAspectRatio:!0,aspectRatio:y.matches?4/3:2/1,scales:{x:{ticks:{autoSkip:!0,callback(m){return d[m]?`${new Date(d[m]).getDate()}日`:""},maxRotation:0,minRotation:0,maxTicksLimit:15}},y:{suggestedMax:Math.max(...r)+1,suggestedMin:n-1,ticks:{maxTicksLimit:y.matches?6:8}}},plugins:{legend:{display:!1},tooltip:{titleFont:{size:y.matches?10:12,family:"Inter, Noto Sans JP, sans-serif"},bodyFont:{size:y.matches?12:14,family:"Inter, Noto Sans JP, sans-serif"},callbacks:{label(m){return` 体重: ${m.raw} kg`}}},annotation:{annotations:{goalLine:{type:"line",yMin:n,yMax:n,borderColor:"#e65100",borderWidth:2,borderDash:[6,6],label:{content:"目標体重",enabled:!0,position:"end"}}}}}}});const L=m=>{const h=m,D=Math.ceil(d.length/h);let u=0;p.data.datasets[0].data=r.map((T,x,S)=>{const i=S.length-1,b=i-x;if(x===i||b%D===0){let A=r.slice(u,x+1).filter(I=>I),v=A.reduce((I,$)=>parseFloat(I)+parseFloat($),0);if(!v)return null;let H=(v/A.length).toFixed(1);return u=x+1,H}else return null})};if(y.matches?(L(12),p.update()):(L(31),p.update()),c==="3m"||c==="6m"||c==="1y"){let m=null;p.options.scales.x.ticks.callback=h=>{let D=new Date(d[h]),u=D.getMonth()+1,T=D.getDate();if(!(u===m||T!==1))return m=u,`${u}月`},p.update()}},f=c=>{const d=s(c).map(_=>_.replaceAll("-","/")),r=d[0],E=d[d.length-1];return`${r}～${E}`},w=document.querySelector(".weight-graph__date");let o="1m";g(o),w.innerHTML=f(o),y.addEventListener("change",()=>g(o));const C=document.querySelectorAll(".weight-graph__switch button"),O=document.querySelectorAll(".weight-summary__block");if(C.length<1)return;C.forEach(c=>{c.addEventListener("click",()=>{var d;(d=document.querySelector(".weight-graph__switch .btn--select"))==null||d.classList.remove("btn--select"),c.classList.add("btn--select")})});const M=c=>{const d=l(c),r=d.dataset.filter(i=>i!==null),E=d.bmi.filter(i=>i!==null),_=d.bfp.filter(i=>i!==null),m=l(c,!0).dataset.filter(i=>i!==null),h=(i,b=1)=>{const k=i.filter(v=>v!=null).map(v=>parseFloat(v.replace(/,/g,"")));return k.length?(k.reduce((v,H)=>v+H,0)/k.length).toFixed(b):null},D=(i,b)=>{if(i.length&&b.length){const k=(h(i)-h(b)).toFixed(1);return k>0?"+"+k:String(k)}else return null},u=i=>i.length?Math.max(...i).toFixed(1):null,T=i=>i.length?Math.min(...i).toFixed(1):null,x={average:h(r),bfp:h(_,2),bmi:h(E,2),in_de:D(r,m),best:u(r),lowest:T(r)};let S;c==="7d"&&(S="1週間"),c==="1m"&&(S="1ヶ月"),c==="3m"&&(S="3ヶ月"),c==="6m"&&(S="半年"),c==="1y"&&(S="1年"),O.forEach(i=>{i.querySelector(".period").innerHTML=S;const b=x[i.dataset.summary];b?i.querySelector(".weight-summary__num").innerHTML=b:i.querySelector(".weight-summary__num").innerHTML="--"})};M(o),document.getElementById("weight-graph__week").addEventListener("click",()=>{o="7d",g(o),w.innerHTML=f(o),M(o)}),document.getElementById("weight-graph__month").addEventListener("click",()=>{o="1m",g(o),w.innerHTML=f(o),M(o)}),document.getElementById("weight-graph__three-month").addEventListener("click",()=>{o="3m",g(o),w.innerHTML=f(o),M(o)}),document.getElementById("weight-graph__half-year").addEventListener("click",()=>{o="6m",g(o),w.innerHTML=f(o),M(o)}),document.getElementById("weight-graph__year").addEventListener("click",()=>{o="1y",g(o),w.innerHTML=f(o),M(o)})};document.querySelector("#header")&&X();document.querySelector(".accordion")&&Z();document.querySelector("#header__info")&&ee();document.querySelector(".weight-days__blocks")&&te();document.querySelector("#graph")&&ne();
